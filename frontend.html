<!DOCTYPE html>
<html>
<head>
  <title>ESP32 AI Camera Monitor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
      background: #fafafa;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      color: #1a1a1a;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 24px 40px;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      color: #1a1a1a;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status.connected {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status.connected::before {
      background: #22c55e;
    }

    .status.disconnected {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status.disconnected::before {
      background: #ef4444;
    }

    .live-section {
      background: white;
      padding: 40px;
      margin-bottom: 1px;
      border-bottom: 1px solid #e5e5e5;
    }

    .section-title {
      font-size: 14px;
      color: #737373;
      margin-bottom: 24px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .camera-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .camera-card {
      background: white;
      border-radius: 2px;
      padding: 0;
      border: 1px solid #e5e5e5;
      transition: border-color 0.2s;
      overflow: hidden;
    }

    .camera-card:hover {
      border-color: #a3a3a3;
    }

    .camera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #fafafa;
      border-bottom: 1px solid #e5e5e5;
    }

    .camera-id {
      font-size: 13px;
      font-weight: 500;
      color: #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .detection-badge {
      font-size: 11px;
      padding: 4px 8px;
      background: #1a1a1a;
      color: white;
      border-radius: 2px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .confidence {
      font-size: 10px;
      color: #737373;
      margin-left: 6px;
    }

    .camera-card img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background: #f5f5f5;
      display: block;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .camera-card img:hover {
      opacity: 0.9;
    }

    .camera-info {
      padding: 16px;
      background: white;
    }

    .ai-analysis {
      margin-bottom: 12px;
    }

    .analysis-label {
      font-size: 11px;
      color: #737373;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .analysis-content {
      font-size: 14px;
      color: #1a1a1a;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .detections-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .detection-tag {
      padding: 4px 10px;
      background: #f5f5f5;
      border: 1px solid #e5e5e5;
      border-radius: 2px;
      font-size: 12px;
      color: #1a1a1a;
    }

    .detection-tag .conf {
      color: #737373;
      margin-left: 4px;
      font-size: 11px;
    }

    .timestamp {
      font-size: 12px;
      color: #737373;
      padding-top: 12px;
      border-top: 1px solid #e5e5e5;
    }

    .history-section {
      background: white;
      padding: 40px;
    }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1px;
      max-height: 650px;
      overflow-y: auto;
      background: #e5e5e5;
      border: 1px solid #e5e5e5;
    }

    .history-item {
      background: white;
      overflow: hidden;
      transition: opacity 0.2s;
      cursor: pointer;
      position: relative;
    }

    .history-item:hover {
      opacity: 0.8;
    }

    .history-item img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #f5f5f5;
      display: block;
    }

    .history-info {
      padding: 12px;
      background: white;
    }

    .history-camera {
      font-size: 11px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .history-time {
      font-size: 11px;
      color: #737373;
    }

    .history-summary {
      font-size: 11px;
      color: #525252;
      margin-top: 4px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #a3a3a3;
      font-size: 14px;
      background: white;
    }

    .history-grid::-webkit-scrollbar {
      width: 12px;
    }

    .history-grid::-webkit-scrollbar-track {
      background: #fafafa;
    }

    .history-grid::-webkit-scrollbar-thumb {
      background: #d4d4d4;
    }

    .history-grid::-webkit-scrollbar-thumb:hover {
      background: #a3a3a3;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.95);
    }

    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 80vh;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .close {
      position: absolute;
      top: 32px;
      right: 40px;
      color: white;
      font-size: 32px;
      font-weight: 300;
      cursor: pointer;
      transition: opacity 0.2s;
      z-index: 1001;
    }

    .close:hover {
      opacity: 0.6;
    }

    .modal-details {
      position: absolute;
      bottom: 32px;
      left: 40px;
      right: 40px;
      background: rgba(255,255,255,0.95);
      color: #1a1a1a;
      padding: 20px;
      border-radius: 2px;
      max-width: 600px;
    }

    .modal-details .camera-id {
      font-size: 12px;
      margin-bottom: 8px;
      color: #737373;
    }

    .modal-details .analysis-content {
      margin-bottom: 8px;
    }

    .modal-details .timestamp {
      border-top: none;
      padding-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ¤– ESP32 AI Camera Monitor</h1>
      <div id="status" class="status disconnected">Disconnected</div>
    </header>

    <div class="live-section">
      <div class="section-title">Live Feeds</div>
      <div id="cameras" class="camera-grid">
        <div class="no-data">Waiting for camera data...</div>
      </div>
    </div>

    <div class="history-section">
      <div class="section-title">Recent Captures</div>
      <div id="history" class="history-grid">
        <div class="no-data">No captures yet</div>
      </div>
    </div>
  </div>

  <div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
    <div class="modal-details" id="modalDetails"></div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io({
      transports: ['websocket', 'polling']
    });
    const camerasDiv = document.getElementById('cameras');
    const historyDiv = document.getElementById('history');
    const statusDiv = document.getElementById('status');
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const modalDetails = document.getElementById('modalDetails');
    const closeModal = document.querySelector('.close');

    let recentEvents = [];

    socket.on('connect', () => {
      console.log('âœ… Connected to server');
      statusDiv.textContent = 'Connected';
      statusDiv.className = 'status connected';
    });

    socket.on('connect_error', (error) => {
      console.error('âŒ Connection error:', error);
    });

    socket.on('disconnect', () => {
      console.log('âŒ Disconnected from server');
      statusDiv.textContent = 'Disconnected';
      statusDiv.className = 'status disconnected';
    });

    socket.on('init', (data) => {
      console.log('ðŸ“¥ Initial data received:', data);
      updateCameras(data.latestPerCamera);
      recentEvents = data.recentEvents || [];
      updateHistory();
    });

    socket.on('detection', (event) => {
      console.log('ðŸŽ¯ New detection:', event);
      updateCamera(event);
      recentEvents.unshift(event);
      if (recentEvents.length > 50) recentEvents.pop();
      updateHistory();
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCameras(cameras) {
      if (Object.keys(cameras).length === 0) return;
      
      camerasDiv.innerHTML = '';
      for (const [cameraId, event] of Object.entries(cameras)) {
        updateCamera(event);
      }
    }

    function updateCamera(event) {
      let card = document.getElementById('cam-' + event.cameraId);
      if (!card) {
        card = document.createElement('div');
        card.id = 'cam-' + event.cameraId;
        card.className = 'camera-card';
        camerasDiv.appendChild(card);
      }

      const time = new Date(event.timestamp).toLocaleString();
      const detections = event.detections || [];
      const sceneDesc = event.sceneDescription || event.scene_description || '';
      const summary = event.summary || '';
      
      let detectionsHtml = '';
      if (detections.length > 0) {
        detectionsHtml = `
          <div class="ai-analysis">
            <div class="analysis-label">Detected Objects</div>
            <div class="detections-list">
              ${detections.map(det => `
                <div class="detection-tag">
                  ${escapeHtml(det.class)}
                  <span class="conf">${(det.confidence * 100).toFixed(0)}%</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      let sceneHtml = '';
      if (sceneDesc) {
        sceneHtml = `
          <div class="ai-analysis">
            <div class="analysis-label">Scene Description</div>
            <div class="analysis-content">"${escapeHtml(sceneDesc)}"</div>
          </div>
        `;
      }

      let summaryHtml = '';
      if (summary && summary !== 'No objects detected') {
        summaryHtml = `
          <div class="ai-analysis">
            <div class="analysis-label">AI Summary</div>
            <div class="analysis-content">${escapeHtml(summary)}</div>
          </div>
        `;
      }

      card.innerHTML = `
        <div class="camera-header">
          <div class="camera-id">${escapeHtml(event.cameraId)}</div>
          ${detections.length > 0 ? `<div class="detection-badge">${detections.length} object${detections.length > 1 ? 's' : ''}</div>` : ''}
        </div>
        <img src="${event.imageBase64}" alt="Camera feed" onclick='openModal(${JSON.stringify(event)})'>
        <div class="camera-info">
          ${summaryHtml}
          ${detectionsHtml}
          ${sceneHtml}
          <div class="timestamp">ðŸ“… ${time}</div>
        </div>
      `;
    }

    function updateHistory() {
      if (recentEvents.length === 0) {
        historyDiv.innerHTML = '<div class="no-data">No captures yet</div>';
        return;
      }

      historyDiv.innerHTML = recentEvents.map((event) => {
        const time = new Date(event.timestamp).toLocaleString();
        const summary = event.summary || 'No detection';
        return `
          <div class="history-item" onclick='openModal(${JSON.stringify(event)})'>
            <img src="${event.imageBase64}" alt="Capture">
            <div class="history-info">
              <div class="history-camera">${escapeHtml(event.cameraId)}</div>
              <div class="history-time">${time}</div>
              ${summary ? `<div class="history-summary">${escapeHtml(summary)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function openModal(event) {
      modal.style.display = 'block';
      modalImg.src = event.imageBase64;
      
      const time = new Date(event.timestamp).toLocaleString();
      const detections = event.detections || [];
      const sceneDesc = event.sceneDescription || event.scene_description || '';
      const summary = event.summary || '';
      
      let detectionsHtml = '';
      if (detections.length > 0) {
        detectionsHtml = `
          <div class="ai-analysis">
            <div class="analysis-label">Detected Objects</div>
            <div class="detections-list">
              ${detections.map(det => `
                <div class="detection-tag">
                  ${escapeHtml(det.class)}
                  <span class="conf">${(det.confidence * 100).toFixed(0)}%</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      modalDetails.innerHTML = `
        <div class="camera-id">Camera: ${escapeHtml(event.cameraId)}</div>
        ${summary ? `<div class="analysis-content"><strong>Summary:</strong> ${escapeHtml(summary)}</div>` : ''}
        ${sceneDesc ? `<div class="analysis-content"><strong>Scene:</strong> "${escapeHtml(sceneDesc)}"</div>` : ''}
        ${detectionsHtml}
        <div class="timestamp">${time}</div>
      `;
    }

    closeModal.onclick = function() {
      modal.style.display = 'none';
    }

    modal.onclick = function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        modal.style.display = 'none';
      }
    });
  </script>
</body>
</html>